<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SafarSync • Your Travel Companion</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Nunito:wght@600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    /* Light Mode Palette */
    --bg: #fdfcfb;
    --card: #ffffff;
    --ink: #1f2a2e;
    --muted: #6f7b81;
    --border-color: #f1ede9;
    --teal: #14B8A6;
    --teal-light: #F0FDFA;
    --teal-dark: #115E59;
    --coral:#F43F5E;
    --amber: #F59E0B;
    --violet: #8B5CF6;
    --sky: #38BDF8;
    --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --radius-lg: 1rem;
    --radius-md: 0.75rem;
    --radius-sm: 0.5rem;
    --gap: 1rem;
    --ring: 0 0 0 3px var(--teal-light);
  }

  body[data-theme="dark"] {
    /* Dark Mode Palette */
    --bg: #111827;
    --card: #1F2937;
    --ink: #F9FAFB;
    --muted: #9CA3AF;
    --border-color: #374151;
    --teal-light: #115E59;
    --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2);
  }

  /* General Resets & Defaults */
  * { box-sizing: border-box; }
  html, body { height: 100%; scroll-behavior: smooth; }
  body{
    margin:0;
    font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    color: var(--ink);
    background-color: var(--bg);
    transition: background-color 0.3s ease, color 0.3s ease;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  a, button { font-family: inherit; }

  /* --- Main Layout & Header --- */
  .topbar{
    position: sticky; top:0; z-index:30;
    backdrop-filter: blur(8px);
    background: rgba(var(--bg-rgb, 253, 252, 251), 0.8);
    border-bottom: 1px solid var(--border-color);
  }
  body[data-theme="dark"] .topbar { --bg-rgb: 17, 24, 39; }

  .topbar-inner{
    max-width: 1200px; margin: 0 auto; padding: 12px 16px;
    display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 1rem;
  }
  .logo{
    font-weight: 800; font-size: 1.25rem;
    font-family: 'Nunito', Inter, sans-serif; color: var(--ink);
  }
  .profile-area { display: flex; align-items: center; gap: 0.75rem; justify-content: flex-end; }
  .username-display { font-weight: 600; display: none; }
  @media(min-width: 640px) { .username-display { display: block; } }

  .icon-btn{
    height:44px; width:44px; border-radius: var(--radius-md); border: 1px solid var(--border-color);
    display:grid; place-items:center; background: var(--card);
    box-shadow: var(--shadow);
    transition: transform .12s ease, box-shadow .2s ease, background-color 0.3s ease;
    cursor: pointer;
    color: var(--ink);
  }
  .icon-btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-lg); }
  .icon-btn:focus-visible{ outline: none; box-shadow: var(--ring), var(--shadow-lg); }
  
  .search-input{
    width: 100%; max-width: 400px; margin: 0 auto;
    border: 1px solid var(--border-color); border-radius: var(--radius-md); height:44px;
    padding: 0 16px; background: var(--card); color: var(--ink);
    box-shadow: var(--shadow);
  }
  .search-input::placeholder{ color: var(--muted); }

  /* --- Main Content Shell --- */
  .container{ max-width:1200px; margin: 0 auto; padding: 1rem 1rem 8rem; }
  .section-head{
    display:flex; align-items:center; justify-content:space-between; gap:1rem; margin: 2rem 0 1rem; flex-wrap: wrap;
  }
  .section-head h2{ margin:0; font-size:1.5rem; letter-spacing:-.5px; }
  .grid{
    display:grid; gap: var(--gap);
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
  
  /* --- Home View Specifics --- */
  .home-actions { display: flex; gap: 0.5rem; }
  .countdown-widget {
    background: linear-gradient(135deg, var(--teal-dark), var(--teal));
    color: white;
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }
  .countdown-widget h3 { margin: 0 0 0.5rem; font-size: 1rem; opacity: 0.9; }
  .countdown-widget .trip-name { font-size: 1.75rem; font-weight: 700; }
  .countdown-widget .timer { font-size: 2.5rem; font-weight: 800; margin-top: 1rem; font-family: 'Nunito', sans-serif; letter-spacing: 2px; }
  .countdown-widget .timer span { font-size: 1rem; font-weight: 400; display: block; opacity: 0.8; letter-spacing: 0; }
  
  .trip-card{
    background: var(--card);
    border:1px solid var(--border-color); border-radius: var(--radius-lg);
    overflow:hidden; box-shadow: var(--shadow);  
    transition: transform .2s ease, box-shadow .2s ease, background-color 0.3s ease;
    display: flex; flex-direction: column;
  }
  .trip-card:hover{ transform: translateY(-4px); box-shadow: var(--shadow-lg); }
  .trip-card .cover{ 
    aspect-ratio: 16/10; background-size: cover; background-position:center;
    position: relative;
  }
  .trip-card .trip-body{ padding: 1rem; flex-grow: 1; }
  .trip-card .trip-title{ font-weight:700; font-size: 1.125rem; margin: 0 0 0.25rem; }
  .trip-card .dates{ color: var(--muted); }
  .trip-card .quick{ display:flex; gap:8px; padding: 0 1rem 1rem; border-top: 1px solid var(--border-color); margin-top: 1rem; padding-top: 1rem; }
  .chip{
    flex:1; display:flex; align-items:center; justify-content:center; gap:8px;
    padding:10px; border-radius: var(--radius-md); border:1px solid var(--border-color); background:var(--bg); cursor:pointer;
    transition: all .2s ease;
  }
  .chip:hover{ transform: translateY(-1px); background: var(--teal-light); border-color: var(--teal); color: var(--teal-dark); }
  
  /* --- List views --- */
  .itinerary-item {
      background-color: var(--card);
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
  }

  /* --- Inside Loop Overlay (for trip details) --- */
  .loop-overlay{ position: fixed; inset: 0; background: rgba(0,0,0,0.5); display:none; align-items: flex-end; justify-content: center; z-index:45; backdrop-filter: blur(4px); }
  .loop-sheet{
    width: min(1024px, 96vw); height: 90vh;
    background:var(--bg); border-radius: 1.5rem 1.5rem 0 0; box-shadow: 0 -30px 80px rgba(16,24,40,.35);
    border:1px solid var(--border-color); display: flex; flex-direction: column;
  }
  .loop-head{ padding: 1rem; display:flex; align-items:center; gap:1rem; background: var(--card); border-bottom:1px solid var(--border-color); z-index:2; }
  .loop-cover{ height: 80px; width: 120px; border-radius: var(--radius-md); background-size: cover; background-position:center; flex-shrink: 0;}
  .invite-code { background: var(--bg); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: var(--radius-md); font-family: monospace; display: flex; align-items: center; gap: 0.5rem; }
  .invite-code button { background: none; border: none; cursor: pointer; color: var(--muted); padding: 0.25rem; display: grid; place-items: center; border-radius: var(--radius-sm); }
  .invite-code button:hover { background: var(--border-color); color: var(--ink); }
  
  .loop-tabs{ display:flex; gap:8px; padding: 12px 16px; position: sticky; top:64px; background:var(--card); border-bottom:1px solid var(--border-color); z-index:1; overflow-x: auto; }
  .ltab{ padding:8px 12px; border:1px solid var(--border-color); border-radius: 999px; cursor:pointer; background:var(--bg); white-space: nowrap;}
  .ltab.active{ background:var(--teal-light); border-color:var(--teal); color:var(--teal-dark); font-weight: 600; }
  .loop-body { overflow-y: auto; flex: 1; }
  .loop-content{ padding: 1rem; display:none; animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .loop-content.active{ display:block; }
  .content-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; margin-bottom: 1rem; }
  .content-header h3 { margin: 0; }
  
  /* --- Loop Content Specifics --- */
  .itinerary-list .itinerary-item { display: flex; gap: 1rem; border-radius: var(--radius-md); padding: 1rem; margin-bottom: 0.75rem; }
  .itinerary-item .time { font-weight: 700; color: var(--teal-dark); font-family: 'Nunito'; font-size: 1.1rem; }
  body[data-theme="dark"] .itinerary-item .time { color: var(--teal); }
  .itinerary-item .details p { margin: 0.25rem 0; }
  .itinerary-item .details .activity { font-weight: 600; }
  .itinerary-item .details .location { font-size: 0.9rem; color: var(--muted); }

  .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem; }
  .photo-item { 
    aspect-ratio: 1/1; 
    border-radius: var(--radius-md); 
    background-size: cover; 
    background-position: center; 
    position: relative; 
  }

  .delete-photo-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 10;
    height: 32px;
    width: 32px;
    border-radius: 99px;
    border: none;
    background: rgba(0,0,0,0.5);
    color: white;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .delete-photo-btn:hover {
    background: var(--coral);
    transform: scale(1.1);
  }
  
  /* --- Re-Added Chat Styles --- */
  .chat-window { 
    max-height: 400px; 
    overflow-y: auto; 
    margin-bottom: 1rem; 
    display: flex; 
    flex-direction: column; 
    gap: 0.75rem; 
  }
  .chat-bubble { 
    padding: 0.75rem 1rem; 
    border-radius: var(--radius-lg); 
    max-width: 75%; 
    line-break: anywhere; 
  }
  .chat-bubble.sent { 
    background: var(--teal); 
    color: white; 
    border-bottom-right-radius: var(--radius-sm); 
    align-self: flex-end; 
  }
  .chat-bubble.received { 
    background: var(--card); 
    border: 1px solid var(--border-color); 
    border-bottom-left-radius: var(--radius-sm); 
    align-self: flex-start; 
  }
  .chat-bubble .sender { 
    font-weight: 600; 
    font-size: 0.8rem; 
    display: block; 
    margin-bottom: 0.25rem; 
    opacity: 0.8; 
  }
  .chat-input-area { 
    display: flex; 
    gap: 0.5rem; 
  }
  #chatInput { 
    flex-grow: 1; 
  }
  /* --- End of Chat CSS --- */


  /* --- Modals --- */
  dialog { border: none; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-lg); width: min(500px, 90vw); background: var(--card); color: var(--ink); }
  dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
  .modal-content { padding: 1.5rem; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
  .modal-header h3 { margin: 0; font-size: 1.25rem; }
  .form-group { margin-bottom: 1rem; }
  .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%; padding: 0.75rem; border-radius: var(--radius-md); border: 1px solid var(--border-color);
    background: var(--bg); color: var(--ink); font-family: inherit; font-size: 1rem;
  }
  .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

  /* --- Utility classes --- */
  .btn {
    border:none; border-radius: var(--radius-md); padding: 10px 16px; cursor:pointer; font-weight:600;
    display: inline-flex; align-items: center; gap: 8px; justify-content: center;
    transition: all 0.2s ease;
  }
  .btn.primary{ background: var(--teal); color:white; }
  .btn.primary:hover { background: var(--teal-dark); }
  .btn.ghost{ background: var(--teal-light); color: var(--teal-dark); }
  .btn.ghost:hover { background: #d1faef; }
  body[data-theme="dark"] .btn.primary { color: var(--ink); }
  body[data-theme="dark"] .btn.ghost { background-color: #374151; color: var(--ink); }

  /* --- Footer --- */
  .footer {
    position: relative;
    background-color: var(--card);
    color: var(--muted);
    font-size: 0.9rem;
    margin-top: 4rem;
    padding: 80px 1rem 2rem; /* Top padding for the wave */
    transition: background-color 0.3s;
    border-top: 1px solid var(--border-color);
  }
  .footer-wave {
    position: absolute; top: 0; left: 0; width: 100%;
    overflow: hidden; line-height: 0; transform: translateY(-1px);
  }
  .footer-wave svg {
    position: relative; display: block; width: calc(100% + 1.3px); height: 100px;
  }
  .footer-wave .shape-fill { fill: var(--card); transition: fill 0.3s; }
  .footer-content { text-align: center; }
  .footer .logo-text {
    font-family: 'Nunito', sans-serif; font-weight: 800;
    font-size: 2rem; color: var(--ink); margin-bottom: 0.5rem;
  }
  .footer p { margin: 0.25rem 0; }
  .footer .creators { margin-top: 1rem; font-size: 1rem; }
  .footer .creators .heart {
      color: var(--coral); display: inline-block;
      animation: pulse 1.5s infinite ease-in-out;
  }
  @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
  }
  body[data-theme="dark"] .footer {
     background-color: #0c111c; border-top-color: #374151;
  }
  body[data-theme="dark"] .footer-wave .shape-fill { fill: #0c111c; }

  /* --- Hide app until logged in --- */
  .app-wrapper.logged-out .topbar,
  .app-wrapper.logged-out .container,
  .app-wrapper.logged-out .footer {
    display: none;
  }
</style>
</head>
<body>

<div class="app-wrapper logged-out"> <header class="topbar" aria-label="App Header">
    <div class="topbar-inner">
      <div class="logo" role="img" aria-label="SafarSync">SafarSync</div>
      <input type="search" id="search" class="search-input" placeholder="Search trips, members, destinations…" />
      <div class="profile-area">
        <span class="username-display" id="username">User</span>
        <button class="icon-btn" id="theme-toggle" aria-label="Toggle theme">
            <i data-feather="sun" class="sun"></i>
            <i data-feather="moon" class="moon" style="display:none;"></i>
        </button>
        <button class="icon-btn" id="btnLogout" aria-label="Log Out">
          <i data-feather="log-out"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="home" class="view active" aria-labelledby="My Trips">
      <div id="countdown" class="countdown-widget"></div>
      <div class="section-head">
        <h2>Active & Upcoming</h2>
        <div class="home-actions">
            <button class="btn ghost" id="joinTripBtn"><i data-feather="arrow-right-circle"></i> Join Trip</button>
            <button class="btn primary" id="addTripBtn"><i data-feather="plus"></i> Create Trip</button>
        </div>
      </div>
      <div class="grid" id="loopGrid"></div>
       <div class="section-head">
        <h2>Past Trips</h2>
      </div>
      <div class="grid" id="pastLoopGrid"></div>
    </section>
  </main>
  
  <footer class="footer">
    <div class="footer-wave">
        <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" class="shape-fill"></path>
        </svg>
    </div>
    <div class="footer-content">
        <div class="logo-text">SafarSync</div>
        <p>Established in 2025</p>
        <p class="creators">Made with <span class="heart">❤</span> by Rishabh Paul &amp; Rishi Shah</p>
    </div>
  </footer>

</div> <div class="loop-overlay" id="loopOverlay" aria-modal="true" role="dialog">
    <div class="loop-sheet">
      <div class="loop-head">
        <div class="loop-cover" id="loopCover"></div>
        <div style="flex:1">
          <div style="font-weight:800; font-size: 1.25rem;" id="loopTitle">Trip Title</div>
          <div class="muted" id="loopSub">Dates • Location</div>
        </div>
        <div class="invite-code" id="inviteCodeDisplay">
            <span>CODE</span>
            <button id="copyCodeBtn" aria-label="Copy invite code"><i data-feather="copy" style="width:16px;height:16px;"></i></button>
        </div>
        <button class="icon-btn" id="closeLoop"><i data-feather="x"></i></button>
      </div>

      <div class="loop-tabs" role="tablist">
        <button class="ltab active" data-ltab="itin">Itinerary</button>
        <button class="ltab" data-ltab="photos">Photos</button>
        <button class="ltab" data-ltab="chat">Chat</button>
        </div>
      <div class="loop-body">
        <div class="loop-content active" id="lc-itin">
            <div class="content-header"><h3>Day Planner</h3><button class="btn primary" id="addItineraryItemBtn"><i data-feather="plus"></i> Add Activity</button></div>
            <div class="itinerary-list" id="itineraryList"></div>
        </div>
        <div class="loop-content" id="lc-photos">
            <div class="content-header"><h3>Shared Album</h3><button class="btn primary" id="addPhotoBtn"><i data-feather="plus"></i> Add Photo</button></div>
            <div class="photo-grid" id="photoGrid"></div>
        </div>
        
        <div class="loop-content" id="lc-chat">
          <div class="chat-window" id="chatWindow"></div>
          <div class="chat-input-area">
            <input type="text" id="chatInput" class="search-input" style="height:auto;" placeholder="Type a message...">
            <button class="btn primary" id="sendChatBtn"><i data-feather="send"></i></button>
          </div>
        </div>
        </div>
    </div>
  </div>
  
  <dialog id="authModal" open> <form class="modal-content" id="authForm">
        <div class="modal-header"><h3>Welcome to SafarSync</h3></div>
        <p style="color:var(--muted); margin-top:-1rem; margin-bottom: 1.5rem;">Please sign in or create an account to continue.</p>
        
        <div class="form-group" id="auth-name-group" style="display:none;">
          <label for="auth-name">Full Name</label>
          <input id="auth-name" type="text" placeholder="Rishabh Paul" required>
        </div>
        <div class="form-group">
          <label for="auth-email">Email</label>
          <input id="auth-email" type="email" placeholder="you@example.com" required>
        </div>
        <div class="form-group">
          <label for="auth-pass">Password</label>
          <input id="auth-pass" type="password" placeholder="••••••••" required>
        </div>

        <div class="modal-actions" style="flex-direction: column; gap: 0.75rem;">
          <button type="submit" class="btn primary" id="btnSignIn" style="width:100%;">Sign In</button>
          <button type="submit" class="btn ghost" id="btnSignUp" style="width:100%;">Create Account</button>
        </div>
        <p id="authError" style="color:var(--coral); text-align:center; margin-top:1rem;"></p>
    </form>
  </dialog>

  <dialog id="joinTripModal">
    <form class="modal-content" method="dialog">
        <div class="modal-header"><h3>Join a Trip</h3><button class="icon-btn" value="cancel" aria-label="Close"><i data-feather="x"></i></button></div>
        <div class="form-group"><label for="join-code">Invite Code</label><input id="join-code" type="text" placeholder="e.g., S-A4N1K9" required></div>
        <div class="modal-actions"><button class="btn ghost" value="cancel" formnovalidate>Cancel</button><button class="btn primary" id="confirmJoinBtn">Join Trip</button></div>
    </form>
  </dialog>

  <dialog id="tripModal">
    <form class="modal-content" method="dialog">
      <div class="modal-header"><h3>Create a new Trip</h3><button class="icon-btn" value="cancel" aria-label="Close"><i data-feather="x"></i></button></div>
      <div class="form-group"><label for="trip-name">Trip Name</label><input id="trip-name" type="text" placeholder="e.g., Bali Getaway" required></div>
      <div class="form-group"><label for="trip-place">Destination</label><input id="trip-place" type="text" placeholder="e.g., Bali, Indonesia" required></div>
      <div class="form-group" style="display: flex; gap: 1rem;">
        <div style="flex:1;"><label for="trip-start">Start Date</label><input id="trip-start" type="date" required></div>
        <div style="flex:1;"><label for="trip-end">End Date</label><input id="trip-end" type="date" required></div>
      </div>
      <div class="form-group"><label for="trip-cover">Cover Image URL (Optional)</label><input id="trip-cover" type="url" placeholder="https://images.unsplash.com/..."></div>
      <div class="modal-actions"><button class="btn ghost" value="cancel" formnovalidate>Cancel</button><button class="btn primary" id="saveTripBtn">Create Trip</button></div>
    </form>
  </dialog>

  <dialog id="itineraryModal">
    <form class="modal-content" method="dialog">
        <div class="modal-header"><h3>Add Itinerary Item</h3><button class="icon-btn" value="cancel" aria-label="Close"><i data-feather="x"></i></button></div>
        <div class="form-group"><label for="itin-time">Time</label><input id="itin-time" type="time" required></div>
        <div class="form-group"><label for="itin-activity">Activity</label><input id="itin-activity" type="text" placeholder="e.g., Sunset Cruise" required></div>
        <div class="form-group"><label for="itin-location">Location (Optional)</label><input id="itin-location" type="text" placeholder="e.g., Marina Dock"></div>
        <div class="modal-actions"><button class="btn ghost" value="cancel" formnovalidate>Cancel</button><button class="btn primary" id="saveItineraryBtn">Add Item</button></div>
    </form>
  </dialog>
  
  <dialog id="photoModal">
    <form class="modal-content" method="dialog">
        <div class="modal-header"><h3>Add Photo</h3><button class="icon-btn" value="cancel" aria-label="Close"><i data-feather="x"></i></button></div>
        <div class="form-group">
          <label for="photo-file">Upload an image</label>
          <input id="photo-file" type="file" accept="image/*" required>
        </div>
        <div class="modal-actions">
          <button class="btn ghost" value="cancel" formnovalidate>Cancel</button>
          <button class="btn primary" id="savePhotoBtn">Add Photo</button>
        </div>
    </form>
  </dialog>


<script>
// =============================================
// === SUPABASE CLIENT & GLOBAL STATE =========
// =============================================

const SUPABASE_URL = 'https://zcwlnnqcakoupvayfdwn.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpjd2xubnFjYWtvdXB2YXlmZHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MTI3NzksImV4cCI6MjA3Nzk4ODc3OX0.QaMFKYApvziXzV1Hyb3Vq7xho4-lBzIXNcXjVqMVjt8';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// This is now a local cache, not the source of truth.
let trips = []; 
let currentUser = null;
let currentTripId = null;

/* --------- Helpers ---------- */
const $ = (q, ctx = document) => ctx.querySelector(q);
const $$ = (q, ctx = document) => Array.from(ctx.querySelectorAll(q));
function initFeather() { feather.replace(); }

// Simple date formatter
function formatTripDates(start, end) {
  if (!start || !end) return "No dates";
  const startDate = new Date(start);
  const endDate = new Date(end);
  const options = { month: 'short', day: 'numeric' };
  const yearOption = { year: 'numeric' };

  if (startDate.getFullYear() !== endDate.getFullYear()) {
    return `${startDate.toLocaleDateString('en-US', {...options, ...yearOption})} – ${endDate.toLocaleDateString('en-US', {...options, ...yearOption})}`;
  } else {
    return `${startDate.toLocaleDateString('en-US', options)} – ${endDate.toLocaleDateString('en-US', {...options, year: 'numeric'})}`;
  }
}

/* --------- Theme Toggle ---------- */
const themeToggle = $('#theme-toggle');
const sunIcon = $('.sun');
const moonIcon = $('.moon');
function setTheme(theme) {
    localStorage.setItem('theme', theme);
    document.body.dataset.theme = theme;
    sunIcon.style.display = theme === 'dark' ? 'none' : 'block';
    moonIcon.style.display = theme === 'dark' ? 'block' : 'none';
}
themeToggle.addEventListener('click', () => {
    const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
});
const savedTheme = localStorage.getItem('theme') || 'light';
setTheme(savedTheme);


/* --------- NEW: Authentication ---------- */
const authModal = $('#authModal');
const authForm = $('#authForm');
const authError = $('#authError');
const appWrapper = $('.app-wrapper');
const usernameDisplay = $('#username');

// Check for existing user session
async function checkUser() {
  const { data: { session }, error } = await supabaseClient.auth.getSession();
  if (session) {
    currentUser = session.user;
    // Fetch profile to get full_name
    const { data: profile } = await supabaseClient
      .from('profiles')
      .select('full_name')
      .eq('id', currentUser.id)
      .single();
    
    usernameDisplay.textContent = profile?.full_name || currentUser.email;
    appWrapper.classList.remove('logged-out');
    authModal.close();
    // Load app data
    renderTrips();
    renderCountdown();
  } else {
    appWrapper.classList.add('logged-out');
    authModal.showModal();
  }
}

// Handle Sign In
$('#btnSignIn').addEventListener('click', async (e) => {
  e.preventDefault();
  authError.textContent = '';
  const email = $('#auth-email').value;
  const password = $('#auth-pass').value;

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

  if (error) {
    authError.textContent = error.message;
  } else {
    checkUser(); // Re-check user, which closes modal and loads app
  }
});

// Handle Sign Up
$('#btnSignUp').addEventListener('click', async (e) => {
  e.preventDefault();
  authError.textContent = '';
  
  const nameGroup = $('#auth-name-group');
  if (nameGroup.style.display === 'none') {
    nameGroup.style.display = 'block';
    authError.textContent = 'Please enter your name and click "Create Account" again.';
    return;
  }
  
  const email = $('#auth-email').value;
  const password = $('#auth-pass').value;
  const fullName = $('#auth-name').value;

  if (!fullName) {
    authError.textContent = 'Please enter your full name.';
    return;
  }

  const { data, error } = await supabaseClient.auth.signUp({
    email,
    password,
    options: {
      data: {
        full_name: fullName 
      }
    }
  });

  if (error) {
    authError.textContent = error.message;
  } else {
    authError.textContent = 'Success! Please check your email to confirm sign up.';
  }
});

// Handle Log Out
$('#btnLogout').addEventListener('click', async () => {
  await supabaseClient.auth.signOut();
  currentUser = null;
  trips = []; 
  appWrapper.classList.add('logged-out');
  authModal.showModal();
  $('#loopGrid').innerHTML = ''; 
  $('#pastLoopGrid').innerHTML = ''; 
});


/* --------- Home View: Trips & Countdown ---------- */
async function renderTrips() {
  const query = $('#search').value.toLowerCase().trim();
  const upcomingGrid = $('#loopGrid'), pastGrid = $('#pastLoopGrid');
  upcomingGrid.innerHTML = '<p>Loading trips...</p>';
  pastGrid.innerHTML = '';

  const { data, error } = await supabaseClient
    .from('trips')
    .select('*')
    .order('start_date', { ascending: false });

  if (error) {
    console.error('Error fetching trips:', error);
    upcomingGrid.innerHTML = '<p style="color:var(--coral)">Error fetching trips.</p>';
    return;
  }

  trips = data; 
  const filtered = trips.filter(t => !query || t.name.toLowerCase().includes(query) || (t.destination && t.destination.toLowerCase().includes(query)));
  
  const today = new Date().toISOString().split('T')[0];
  const upcoming = filtered.filter(t => t.end_date >= today);
  const past = filtered.filter(t => t.end_date < today);

  upcomingGrid.innerHTML = '';
  pastGrid.innerHTML = '';

  (upcoming.length > 0 ? upcoming : [{p:1, t: "No upcoming trips found."}]).forEach(trip => upcomingGrid.appendChild(createTripCard(trip)));
  (past.length > 0 ? past : [{p:1, t: "No past trips found."}]).forEach(trip => pastGrid.appendChild(createTripCard(trip)));
  
  renderCountdown();
  initFeather(); 
}
$('#search').addEventListener('input', renderTrips);


function createTripCard(trip) {
    if (trip.p) { 
      const p = document.createElement('div'); 
      p.textContent = trip.t || "No trips here yet!"; 
      p.style.color = 'var(--muted)'; 
      return p; 
    }
    
    const card = document.createElement('article'); 
    card.className = 'trip-card';
    
    const displayDates = formatTripDates(trip.start_date, trip.end_date);
    const coverImg = trip.cover_image || `https://placehold.co/600x400/14b8a6/ffffff?text=${encodeURIComponent(trip.name)}`;
    
    // --- CHAT BUTTON RE-ADDED TO CARD QUICKLINKS ---
    card.innerHTML = `
      <div class="cover" style="background-image:url('${coverImg}')"></div>
      <div class="trip-body">
        <div class="trip-title">${trip.name}</div>
        <div class="dates">${displayDates} • ${trip.destination || 'TBD'}</div>
      </div>
      <div class="quick">
        <button class="chip" data-act="itin"><i data-feather="calendar" style="width:18px"></i> Itinerary</button>
        <button class="chip" data-act="chat"><i data-feather="message-square" style="width:18px"></i> Chat</button>
      </div>`;
      
    card.addEventListener('click', (e) => { 
      const chipBtn = e.target.closest('.chip');
      if (chipBtn) {
        e.stopPropagation();
        const act = chipBtn.dataset.act;
        openLoop(trip.id, act);
      } else {
        openLoop(trip.id, 'itin');
      }
    });

    return card;
}


function renderCountdown() {
    const upcoming = trips
      .filter(t => new Date(t.start_date) > new Date())
      .sort((a,b) => new Date(a.start_date) - new Date(b.start_date));
      
    if (upcoming.length === 0) { 
      $('#countdown').style.display = 'none'; 
      return; 
    }
    
    $('#countdown').style.display = 'block';
    const next = upcoming[0];
    const target = new Date(next.start_date).getTime();
    
    if (window.countdownInterval) clearInterval(window.countdownInterval);
    
    const updateTimer = () => {
        const d = target - new Date().getTime();
        if (d < 0) {
            clearInterval(window.countdownInterval);
            $('#countdown').innerHTML = `<div class="trip-name">${next.name} is happening now!</div>`;
            return;
        }
        const days = Math.floor(d/(1000*60*60*24));
        const hrs = Math.floor((d%(1000*60*60*24))/(1000*60*60));
        const mins = Math.floor((d%(1000*60*60))/(1000*60));
        $('#countdown').innerHTML = `<h3>NEXT TRIP</h3><div class="trip-name">${next.name}</div><div class="timer">${days}d ${hrs}h ${mins}m<span>to go!</span></div>`;
    };
    
    updateTimer(); // Run immediately
    window.countdownInterval = setInterval(updateTimer, 1000);
}

/* --- Create/Join Trip & Modal Logic --- */
$('#addTripBtn').addEventListener('click', () => $('#tripModal').showModal());
$('#joinTripBtn').addEventListener('click', () => $('#joinTripModal').showModal());

// Universal modal close handler
$$('dialog').forEach(dialog => {
    dialog.addEventListener('click', (e) => {
        if (e.target.nodeName === 'DIALOG') dialog.close();
    });
    $$('button[value="cancel"]', dialog).forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            dialog.close();
        });
    });
});

$('#saveTripBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const name = $('#trip-name').value.trim();
    const place = $('#trip-place').value.trim(); // JS variable, maps to 'destination'
    const start = $('#trip-start').value;
    const end = $('#trip-end').value;
    const cover = $('#trip-cover').value.trim();
    
    if (!name || !place || !start || !end) { 
      return alert("Please fill in all required fields."); 
    }

    const { data: newTrip, error } = await supabaseClient.rpc('create_trip', {
      name: name,
      destination: place,
      start_date: start,
      end_date: end,
      cover_image: cover || null
    });

    if (error) {
      console.error('Error creating trip:', error);
      alert(`Error: ${error.message}`);
    } else {
      alert(`Trip "${newTrip.name}" created!`);
      $('#tripModal').close();
      $('#tripModal form').reset();
      await renderTrips(); 
    }
});

$('#confirmJoinBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const code = $('#join-code').value.trim();
    if (!code) return;

    const { data: joinedTrip, error } = await supabaseClient.rpc('join_trip', {
      invite_code_to_join: code
    });

    if (error) {
      console.error('Error joining trip:', error);
      alert(`Error: ${error.message}`);
    } else {
      alert(`Successfully joined "${joinedTrip.name}"!`);
      $('#joinTripModal').close();
      $('#joinTripModal form').reset();
      await renderTrips(); 
    }
});

/* --------- Inside Loop Overlay Logic ---------- */
const overlay = $('#loopOverlay');

async function openLoop(id, focusTab = 'itin') {
    currentTripId = id;
    const trip = trips.find(t => t.id === id); 
    if (!trip) {
      console.error('Trip not found in local cache');
      return;
    }

    const coverImg = trip.cover_image || `https://placehold.co/600x400/14b8a6/ffffff?text=${encodeURIComponent(trip.name)}`;
    $('#loopCover').style.backgroundImage = `url('${coverImg}')`;
    $('#loopTitle').textContent = trip.name;
    $('#loopSub').textContent = `${formatTripDates(trip.start_date, trip.end_date)} • ${trip.destination}`;
    $('#inviteCodeDisplay > span').textContent = trip.invite_code;
    
    setLoopTab(focusTab);
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // ASYNC Fetch subdetails
    renderTripItinerary(trip.id); 
    renderTripPhotos(trip.id); 
    renderChat(trip.id); // <-- RE-ADDED
}

$('#closeLoop').addEventListener('click', () => { 
  overlay.style.display = 'none'; 
  document.body.style.overflow = ''; 
  currentTripId = null; 
});
$$('.ltab').forEach(b => b.addEventListener('click', () => setLoopTab(b.dataset.ltab)));
function setLoopTab(key) { 
  $$('.ltab').forEach(b => b.classList.toggle('active', b.dataset.ltab === key)); 
  $$('.loop-content').forEach(v => v.classList.remove('active')); 
  $('#lc-' + key).classList.add('active'); 
}

$('#copyCodeBtn').addEventListener('click', () => {
    const code = $('#inviteCodeDisplay > span').textContent;
    navigator.clipboard.writeText(code).then(() => {
        alert(`Copied "${code}" to clipboard!`);
    });
});

/* --- Itinerary Tab --- */
async function renderTripItinerary(tripId) {
    const list = $('#itineraryList');
    list.innerHTML = '<p>Loading itinerary...</p>';
    
    const { data, error } = await supabaseClient
      .from('itinerary_items')
      .select('*')
      .eq('trip_id', tripId)
      .order('time');

    if (error) return (list.innerHTML = '<p style="color:var(--coral)">Error loading itinerary.</p>');
    if (data.length === 0) return (list.innerHTML = `<p style="color:var(--muted)">No itinerary items yet. Add the first activity!</p>`);
    
    list.innerHTML = ''; 
    data.forEach(item => {
        const el = document.createElement('div'); 
        el.className = 'itinerary-item';
        el.innerHTML = `
          <div class="time">${item.time.substring(0, 5)}</div>
          <div class="details">
            <p class="activity">${item.activity}</p>
            <p class="location">${item.location || ''}</p>
          </div>`;
        list.appendChild(el);
    });
}
$('#addItineraryItemBtn').addEventListener('click', () => $('#itineraryModal').showModal());
$('#saveItineraryBtn').addEventListener('click', async e => {
    e.preventDefault();
    if (!currentTripId) return;

    const newItem = {
      trip_id: currentTripId,
      time: $('#itin-time').value, 
      activity: $('#itin-activity').value, 
      location: $('#itin-location').value 
    };
    
    if (newItem.time && newItem.activity) {
      const { error } = await supabaseClient.from('itinerary_items').insert(newItem);
      if (error) {
        alert(`Error: ${error.message}`);
      } else {
        renderTripItinerary(currentTripId); 
        $('#itineraryModal').close(); 
        $('#itineraryModal form').reset();
      }
    }
});


/* --- Photos Tab (Upload/Delete Enabled) --- */
async function renderTripPhotos(tripId) {
    const grid = $('#photoGrid');
    grid.innerHTML = '<p>Loading photos...</p>';

    const { data, error } = await supabaseClient
      .from('photos')
      .select('id, photo_url')
      .eq('trip_id', tripId)
      .order('created_at', { ascending: false });

    if (error) return (grid.innerHTML = '<p style="color:var(--coral)">Error loading photos.</p>');
    if (data.length === 0) return (grid.innerHTML = `<p style="color:var(--muted)">No photos shared yet. Be the first!</p>`);

    grid.innerHTML = ''; 
    data.forEach(item => { 
      const el = document.createElement('div'); 
      el.className = 'photo-item'; 
      el.style.backgroundImage = `url(${item.photo_url})`; 
      
      el.innerHTML = `
        <button class="delete-photo-btn" data-id="${item.id}" data-url="${item.photo_url}" title="Delete photo">
          <i data-feather="x" style="width:16px; height:16px;"></i>
        </button>
      `;
      
      grid.appendChild(el); 
    });
    initFeather(); // Refresh icons
}

$('#addPhotoBtn').addEventListener('click', () => $('#photoModal').showModal());

$('#savePhotoBtn').addEventListener('click', async e => {
    e.preventDefault();
    if (!currentTripId) return;
    
    const fileInput = $('#photo-file');
    const file = fileInput.files[0];
    
    if (!file) {
      alert("Please select a file to upload.");
      return;
    }

    e.target.disabled = true;
    e.target.textContent = 'Uploading...';

    try {
      const filePath = `${currentTripId}/${Date.now()}-${file.name}`;

      const { error: uploadError } = await supabaseClient.storage
        .from('photos') 
        .upload(filePath, file);

      if (uploadError) throw uploadError;

      const { data: publicURLData } = supabaseClient.storage
        .from('photos')
        .getPublicUrl(filePath);

      if (!publicURLData.publicUrl) throw new Error("Could not get public URL.");
      
      const { error: insertError } = await supabaseClient.from('photos').insert({
        trip_id: currentTripId,
        photo_url: publicURLData.publicUrl
      });

      if (insertError) throw insertError;

      renderTripPhotos(currentTripId); 
      $('#photoModal').close(); 
      $('#photoModal form').reset(); 

    } catch (error) {
      console.error("Error uploading photo:", error);
      alert(`Error: ${error.message}`);
    } finally {
      e.target.disabled = false;
      e.target.textContent = 'Add Photo';
    }
});

$('#photoGrid').addEventListener('click', async (e) => {
  const deleteBtn = e.target.closest('.delete-photo-btn');
  if (!deleteBtn) return; 

  if (!confirm('Are you sure you want to delete this photo?')) return;

  const photoId = deleteBtn.dataset.id;
  const photoUrl = deleteBtn.dataset.url;

  try {
    const filePath = new URL(photoUrl).pathname.split('/photos/')[1];

    const { error: storageError } = await supabaseClient.storage
      .from('photos')
      .remove([filePath]);
    
    const { error: dbError } = await supabaseClient
      .from('photos')
      .delete()
      .eq('id', photoId);

    if (dbError) throw dbError;

    renderTripPhotos(currentTripId);

  } catch (error) {
    console.error('Error deleting photo:', error);
    alert(`Error: ${error.message}`);
  }
});


/* --- !!! CHAT FUNCTIONS RE-ADDED AND FIXED !!! --- */

/* --- Chat Tab (FIXED) --- */
async function renderChat(tripId) {
    const win = $('#chatWindow');
    win.innerHTML = '<p>Loading chat...</p>';

    // --- THIS IS THE FIX ---
    // We are selecting all columns (*) just like the itinerary,
    // instead of trying to join the profiles table.
    const { data, error } = await supabaseClient
      .from('chat_messages')
      .select('*') // <-- CHANGED
      .eq('trip_id', tripId)
      .order('created_at');
    // --- END OF FIX ---
    
    if (error) {
      console.error("Chat fetch error:", error);
      return (win.innerHTML = '<p style="color:var(--coral)">Error loading chat.</p>');
    }

    win.innerHTML = ''; 
    if (data.length === 0) {
      win.innerHTML = '<p style="color:var(--muted); text-align:center;">No messages yet. Say hello!</p>';
    }
    
    data.forEach(msg => { 
      const b = document.createElement('div'); 
      const isSent = msg.sender_id === currentUser.id;
      b.className = `chat-bubble ${isSent ? 'sent' : 'received'}`;
      
      // This logic now works perfectly because we are not relying on a 'profile' object
      const senderName = isSent ? 'You' : 'Guest'; // Simplified: Shows "You" or "Guest"
      
      b.innerHTML = `<span class="sender">${senderName}</span>${msg.message}`; 
      win.appendChild(b); 
    });
    win.scrollTop = win.scrollHeight;
}

$('#sendChatBtn').addEventListener('click', async () => {
    const input = $('#chatInput');
    const msg = input.value.trim();
    if (msg && currentTripId) {
      const { error } = await supabaseClient.from('chat_messages').insert({
        trip_id: currentTripId,
        message: msg
      });

      if (error) {
        alert(`Error: ${error.message}`);
      } else {
        input.value = ''; 
        input.focus();
        // Optimistic update
        const win = $('#chatWindow');
        if (win.querySelector('p')) win.innerHTML = ''; 
        
        const b = document.createElement('div');
        b.className = 'chat-bubble sent';
        b.innerHTML = `<span class="sender">You</span>${msg}`;
        win.appendChild(b);
        win.scrollTop = win.scrollHeight;
      }
    }
});
$('#chatInput').addEventListener('keypress', (e) => { 
  if(e.key === 'Enter') {
    e.preventDefault(); 
    $('#sendChatBtn').click();
  }
});
/* --- !!! END OF CHAT SECTION !!! --- */


/* --- EXPENSES AND MEMBERS FUNCTIONS REMOVED --- */


/* --------- Initial Render Calls ---------- */
document.addEventListener('DOMContentLoaded', () => {
    checkUser(); // Check user first, which will then trigger rendering
    initFeather();
});
</script>
</body>
</html>